<?php
include_once "../include/header.html";
$PAGE_CODE_1 = "04";
$PAGE_CODE_2 = "0402";
?>
<main id="subPage" class="statistics supply">
    <section class="sub_banner">
        <div class="bg">
            <img src="../images/statistics/statistics_banner.png" alt="통계/현황 베너">
        </div>
        <?php include_once "../include/tabmenu.html" ?>
    </section>
    <section class="s01">
        <article>
            <div class="wrap">
                <div class="title">공급현황</div>
            </div>
        </article>
    </section>
    <section class="s02">
        <article>
            <div class="wrap">
                <div class="tabs">
                    <a href="#none" class="active">총괄</a>
                    <a href="#none">지역난방</a>
                    <a href="#none">산업단지</a>
                    <a href="#none">병행사업자</a>
                    <a href="#none">지역냉방</a>
                </div>
                <div class="caption">
                    <div class="left">
                        <h3>2018 총괄 공급현황</h3>
                        <ul class="pie colorType03">
                            <li>지역냉난방</li>
                            <li>산업단지</li>
                            <li>병행</li>
                        </ul>
                    </div>
                    <div class="right">
                        <span>실적년도</span>
                        <select>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                            <option value="2016">2016</option>
                            <option value="2015">2015</option>
                            <option value="2014">2014</option>
                            <option value="2013">2013</option>
                            <option value="2012">2012</option>
                        </select>
                    </div>
                </div>
                <div class="canvas-wrap">
                    <div class="box">
                        <div class="canvas-title">2018 사업자수 현황</div>
                        <canvas id="supply_chart01"></canvas>
                    </div>
                    <div class="box">
                        <div class="canvas-title">2018 사업장수 현황</div>
                        <canvas id="supply_chart02"></canvas>
                    </div>
                    <div class="box">
                        <div class="canvas-title">2018 허가현황(세대수)</div>
                        <canvas id="supply_chart03"></canvas>
                    </div>
                    <div class="box">
                        <div class="canvas-title">2018 허가현황(업체수)</div>
                        <canvas id="supply_chart04"></canvas>
                    </div>
                    <div class="box">
                        <div class="canvas-title">2018 공급현황(세대수)</div>
                        <canvas id="supply_chart05"></canvas>
                    </div>
                    <div class="box">
                        <div class="canvas-title">2018 공급현황(업체수)</div>
                        <canvas id="supply_chart06"></canvas>
                    </div>
                </div>
                <ul class="info">
                    <li>
                        <div class="caption">
                            <h3>2018 공급중 집단에너지사업 허가 및 공급현황</h3>
                        </div>
                        <div class="table-box">
                            <table class="supply_table01">
                                <thead>
                                    <tr>
                                        <th>구분</th>
                                        <th>사업자 수</th>
                                        <th>사업장 수</th>
                                        <th>허가 세대수</th>
                                        <th>허가 업체수</th>
                                        <th>공급 세대수</th>
                                        <th>공급 업체수</th>
                                        <th>공급 빌딩수</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>지역냉난방</td>
                                        <td>32</td>
                                        <td>61</td>
                                        <td>3,822,397</td>
                                        <td>0</td>
                                        <td>3,017,347</td>
                                        <td>0</td>
                                        <td>4,708</td>
                                    </tr>
                                    <tr>
                                        <td>산업단지</td>
                                        <td>39</td>
                                        <td>41</td>
                                        <td>0</td>
                                        <td>885</td>
                                        <td>0</td>
                                        <td>862</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>병행</td>
                                        <td>6</td>
                                        <td>6 </td>
                                        <td>149,585</td>
                                        <td>77</td>
                                        <td>88,637</td>
                                        <td>72 </td>
                                        <td>73</td>
                                    </tr>
                                    <tr class="bold">
                                        <td>합계</td>
                                        <td>77</td>
                                        <td>3,971,982</td>
                                        <td>962</td>
                                        <td>3,105,984</td>
                                        <td>934</td>
                                        <td>72</td>
                                        <td>4,781</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </li>
                    <li>
                        <div class="caption">
                            <h3>2018 건설중 집단에너지사업 허가 및 공급현황</h3>
                        </div>
                        <div class="table-box">
                            <table class="supply_table02">
                                <thead>
                                    <tr>
                                        <th>구분</th>
                                        <th>사업자 수</th>
                                        <th>사업장 수</th>
                                        <th>허가 세대수</th>
                                        <th>허가 업체수</th>
                                        <th>공급 세대수</th>
                                        <th>공급 업체수</th>
                                        <th>공급 빌딩수</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>지역냉난방</td>
                                        <td>2</td>
                                        <td>2</td>
                                        <td>126,361</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>산업단지</td>
                                        <td>4</td>
                                        <td>4</td>
                                        <td>0</td>
                                        <td>61</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                    <tr>
                                        <td>병행</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>0</td>
                                        <td>8</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                    <tr class="bold">
                                        <td>합계</td>
                                        <td>7</td>
                                        <td>7</td>
                                        <td>126,361</td>
                                        <td>8</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </li>
                </ul>
            </div>
        </article>
    </section>
</main>
<?php
include_once "../include/footer.html"
?>

<script>
    let ctx_canvas = document.querySelectorAll(".canvas-wrap canvas"),
        data01_element = document.querySelectorAll(".supply_table01 tbody tr");

    let data_area = {
        label: [],
        data01: [],
        data02: [],
        data03: [],
        data04: [],
        data05: [],
        data06: [],
        data07: [],
    }
    data01_element.forEach((el, index) => {
        // 합계 제외
        if (index == 3) return false;
        data_area.label.push(el.querySelectorAll("td")[0].textContent.replace(/,/g, "").trim());
        data_area.data01.push(el.querySelectorAll("td")[1].textContent.replace(/,/g, "").trim());
        data_area.data02.push(el.querySelectorAll("td")[2].textContent.replace(/,/g, "").trim());
        data_area.data03.push(el.querySelectorAll("td")[3].textContent.replace(/,/g, "").trim());
        data_area.data04.push(el.querySelectorAll("td")[4].textContent.replace(/,/g, "").trim());
        data_area.data05.push(el.querySelectorAll("td")[5].textContent.replace(/,/g, "").trim());
        data_area.data06.push(el.querySelectorAll("td")[6].textContent.replace(/,/g, "").trim());
        data_area.data07.push(el.querySelectorAll("td")[7].textContent.replace(/,/g, "").trim());
    });

    // chartjs 폰트 반응형
    function font_size(context) {
        const width = context.chart.width
        const size = Math.round(width / 13)

        return {
            size: size <= 14 ? 14 : size,
            weight: 600,
        }
    };

    // chartjs 옵션
    let options = {
        responsive: false,
        maintainAspectRatio: false,
        layout: {
            padding: 20,
        },
        plugins: {
            legend: {
                display: false,
            },
            tooltip: tooltip(),
            datalabels: {
                formatter: function(value, context) {
                    let t = (value / context.chart.getDatasetMeta(0).total * 100).toFixed(1);
                    if (t % 1 == 0) t = Math.floor(t);
                    return (t <= 10 ? "" : t + "%");
                },
                color: '#fff',
                font: font_size,
            }
        },
    };

    // chartjs 값(데이터)
    function data(data_value) {
        return {
            labels: data_area.label,
            datasets: [{
                data: data_value,
                borderColor: 'transparent',
                fill: true,
                backgroundColor: ['rgba(51,137,239,.8)', '#D6F2FE', '#EFFAFF'],
                hoverBackgroundColor: ['#3389ef', '#74d1fa', '#c7eeff'],
                borderWidth: 1,
                borderColor: '#fff',
                hoverOffset: 20,
            }]
        }
    }

    // chartjs 툴팁
    function tooltip() {
        let padding = {
            top: 15,
            bottom: 15,
            left: 10,
            right: 10,
        }

        if (window.innerWidth <= 1024) {
            padding = {
                top: 10,
                bottom: 10,
                left: 7,
                bottom: 7,
            };
        }
        return {
            enabled: false,
            backgroundColor: "#fff",
            borderColor: "#707070",
            borderWidth: ".5",
            padding: padding,
            bodyColor: "#000",
            bodyFont: {
                size: 12,
                weight: 400,
                family: "ScoreDream",
            },
            callbacks: {
                title: function() {
                    return null;
                },
                label: function(context) {
                    let t = context.formattedValue.replace(/,/g, "") / context.chart.getDatasetMeta(0).total * 100;
                    return `${context.label}/${context.formattedValue}/${t.toFixed(1)}%`;
                }
            },
            external: function(context) {
                let tooltipEl = document.getElementById('chartjs-tooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'chartjs-tooltip';
                    document.body.appendChild(tooltipEl);
                }
                const tooltipModel = context.tooltip;
                if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }

                tooltipEl.classList.remove('above', 'below', 'no-transform');
                if (tooltipModel.yAlign) {
                    tooltipEl.classList.add(tooltipModel.yAlign);
                } else {
                    tooltipEl.classList.add('no-transform');
                }

                function getBody(bodyItem) {
                    return bodyItem.lines;
                }

                // Set Text
                if (tooltipModel.body) {
                    const bodyLines = tooltipModel.body.map(getBody);
                    let hoverBackgroundColor = this.dataPoints[0].dataset.hoverBackgroundColor;
                    let bg_color = hoverBackgroundColor[this.dataPoints[0].dataset.data.indexOf(bodyLines[0][0].split("/")[1].replace(/,/g, ""))];
                    bodyLines.forEach(function(el, index) {
                        let innerHtml = el[0].split("/");
                        tooltipEl.innerHTML = `
                            <div class="normal">
                                <div><div class="box" style="background-color: ${bg_color}"></div>${innerHtml[0]}</div> 
                                <div>${innerHtml[1]} (${innerHtml[2]})</div>
                            </div>
                        `;
                    });
                }

                const position = context.chart.canvas.getBoundingClientRect();
                tooltipEl.style.opacity = 1;
                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX - tooltipEl.getBoundingClientRect().width / 2 + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
            }
        }
    }

    const year_chart1 = new Chart(ctx_canvas[0], {
        type: 'pie',
        data: data(data_area.data01),
        options: options,
        plugins: [ChartDataLabels]
    });
    const year_chart2 = new Chart(ctx_canvas[1], {
        type: 'pie',
        data: data(data_area.data02),
        options: options,
        plugins: [ChartDataLabels]
    });
    const year_chart3 = new Chart(ctx_canvas[2], {
        type: 'pie',
        data: data(data_area.data03),
        options: options,
        plugins: [ChartDataLabels]
    });
    const year_chart4 = new Chart(ctx_canvas[3], {
        type: 'pie',
        data: data(data_area.data04),
        options: options,
        plugins: [ChartDataLabels]
    });
    const year_chart5 = new Chart(ctx_canvas[4], {
        type: 'pie',
        data: data(data_area.data05),
        options: options,
        plugins: [ChartDataLabels]
    });
    const year_chart6 = new Chart(ctx_canvas[5], {
        type: 'pie',
        data: data(data_area.data06),
        options: options,
        plugins: [ChartDataLabels]
    });
</script>